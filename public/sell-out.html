<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Relatório Sell Out</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: url('https://images.unsplash.com/photo-1504384308090-c894fdcc538d?auto=format&fit=crop&w=1470&q=80') no-repeat center/cover;
    min-height: 100vh;
    margin: 0; padding: 1rem;
    display: flex; justify-content: center;
  }
  #container {
    background: rgba(255,255,255,0.95);
    max-width: 720px; width: 100%;
    padding: 1.5rem 2rem; border-radius: 15px;
    box-shadow: 0 4px 15px rgb(0 0 0 / 0.2);
  }
  h2, h3 { text-align: center; margin-bottom: 1rem; }
  form {
    display: grid; gap: 1rem; margin-bottom: 1rem;
  }
  select, input {
    padding: 0.5rem; font-size: 1rem;
    border: 1.8px solid #ccc; border-radius: 6px;
    width: 100%; box-sizing: border-box;
  }
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  button {
    background-color: #2563eb; color: white;
    font-weight: bold; padding: 0.7rem;
    border: none; border-radius: 6px;
    cursor: pointer; font-size: 1rem;
  }
  button:hover { background-color: #1e40af; }
  #message {
    text-align: center; font-weight: bold; margin-bottom: 1rem;
  }
  .message-success { color: green; }
  .message-error { color: red; }
  .report-card {
    border: 1.5px solid #ddd;
    border-radius: 12px; padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 1px 4px rgb(0 0 0 / 0.1);
    transition: transform 0.3s ease;
    position: relative;
  }
  .report-card:hover { transform: scale(1.02) rotate(1deg); }
  .report-card p { margin: 0.3rem 0; }
  .report-header { font-weight: bold; }
  .growth-positive { color: green; }
  .growth-negative { color: red; }
  .btn-delete {
    background-color: #dc2626; margin-top: 0.7rem; width: 100%;
  }
  canvas {
    display: block; margin: 1rem auto 0;
  }
  .icon-arrow {
    font-weight: bold; font-size: 1.3rem; vertical-align: middle; margin-left: 6px;
  }
</style>
</head>
<body>
<div id="container">
  <h2>Relatório de Sell Out</h2>
  <form id="form-relatorio" autocomplete="off">
    <select id="mes" required><option value="" disabled selected>Selecione o mês</option></select>

    <!-- ALTERAÇÃO AQUI: múltipla seleção com limite de 6 -->
    <select id="filial" required multiple size="6"><option disabled>Selecione até 6 filiais</option></select>

    <div class="grid-2">
      <select id="classificacao" required><option value="" disabled selected>Classificação</option></select>
      <select id="regiao" required><option value="" disabled selected>Região</option></select>
    </div>

    <div class="grid-2">
      <input id="mesAnterior" type="text" inputmode="decimal" placeholder="Sell Out Anterior (R$)" required />
      <input id="mesAtual" type="text" inputmode="decimal" placeholder="Sell Out Atual (R$)" required />
    </div>

    <button type="submit">Salvar Relatório</button>
  </form>

  <p id="message"></p>

  <h3>Relatórios Salvos:</h3>
  <div id="lista-relatorios"></div>
</div>

<script>
  const meses = [
    "Janeiro","Fevereiro","Março","Abril","Maio","Junho",
    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro",
    "JAN x JUN 25x24", "JUL x DEZ 25x24"
  ];
  const classificacoes = ["TODAS","PPOP","MPOP","GPOP","GGPOP","PTOP","MTOP","GTOP","GGTOP"];
  const regioes = ["TODAS","OESTE","NORTE","SUL","BARRA","RECREIO","SERRANA","OCEÂNICA","LAGOS","NITERÓI","BAIXADA","TIJUCA","ILHA"];
  const filiais = [
    "TODAS",
    "AP02 - Jardim Oceânico","AP03 - Notre Dame","AP04 - Pau Ferro","AP05 - Guignard","AP06 - Barra (Rio Design)",
    "AP07 - Barra (Shell)","AP08 - Anil","AP09 - Pedro Correa","AP10 - Ilha Guanabara","AP11 - Copacabana",
    "AP12 - Taquara","AP13 - Campo Grande","AP14 - Geremário Dantas","AP15 - Tijuca","AP16 - Cachamorra",
    "AP17 - Ilha Dende","AP18 - Shopping Nova Iguaçu","AP19 - Petropolis","AP20 - Piratininga",
    "AP21 - Abelardo Bueno","AP22 - Botafogo","AP23 - Meier","AP24 - Vila Isabel","AP25 - Ipanema",
    "AP26 - Santa Rosa","AP27 - Realengo","AP28 - Recreio Americas","AP30 - Caxias","AP31 - Conde de Bonfim",
    "AP32 - Recreio Gilka","AP33 - Catete","AP34 - Cacuia","AP35 - Nova Iguaçu Dutra","AP36 - Copacabana  II",
    "AP37 - Itaipu","AP39 - Estacio","AP40 - Bonsucesso","AP41 - Bangu","AP42 - Itaboraí",
    "AP43 - Petrópolis Araras","AP44 - Campo Grande Monteiro","AP45 - São João de Meriti","AP47 - Petrópolis II",
    "AP48 - Valqueire","AP49 - Araruama","AP50- Icaraí","AP51 - Aerotown","AP52 - São Pedro da Aldeia",
    "AP53 - Barra Golf","AP54 - Cachambi","AP55 - Itaipú II","AP56 - Teresopolis","AP57 - Maricá","AP58 - Vargem Grande"
  ];

  const mesEl = document.getElementById('mes');
  const filialEl = document.getElementById('filial');
  const classificacaoEl = document.getElementById('classificacao');
  const regiaoEl = document.getElementById('regiao');
  const mesAnteriorEl = document.getElementById('mesAnterior');
  const mesAtualEl = document.getElementById('mesAtual');
  const form = document.getElementById('form-relatorio');
  const messageEl = document.getElementById('message');
  const listaRelatoriosEl = document.getElementById('lista-relatorios');

  function popularSelect(element, items) {
    for (const item of items) {
      const opt = document.createElement('option');
      opt.value = item;
      opt.textContent = item;
      element.appendChild(opt);
    }
  }
  popularSelect(mesEl, meses);
  popularSelect(filialEl, filiais);
  popularSelect(classificacaoEl, classificacoes);
  popularSelect(regiaoEl, regioes);

  function normalizarValor(valor) {
    const num = parseFloat(valor.replace(/\./g, '').replace(',', '.'));
    return isNaN(num) ? 0 : num;
  }
  function formatarMoeda(valor) {
    return valor.toLocaleString('pt-BR', { style:'currency', currency:'BRL', minimumFractionDigits:2 });
  }
  function calcularCrescimento(anterior, atual) {
    if (anterior === 0) return 100;
    return ((atual - anterior) / anterior) * 100;
  }

  function carregarRelatorios() {
    const data = localStorage.getItem('sellOutData');
    return data ? JSON.parse(data) : [];
  }
  function salvarRelatorios(relatorios) {
    localStorage.setItem('sellOutData', JSON.stringify(relatorios));
  }

  function desenharGraficoRosca(canvas, anterior, atual) {
    const ctx = canvas.getContext('2d');
    const total = anterior + atual;
    if (total === 0) {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#999';
      ctx.font = '16px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('Sem dados', canvas.width/2, canvas.height/2);
      return;
    }
    const centerX = canvas.width/2;
    const centerY = canvas.height/2;
    const outerRadius = Math.min(centerX, centerY) - 10;
    const innerRadius = outerRadius * 0.6;

    ctx.clearRect(0,0,canvas.width,canvas.height);

    const angAnterior = (anterior/total)*2*Math.PI;
    const angAtual = (atual/total)*2*Math.PI;

    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, outerRadius, 0, angAnterior);
    ctx.lineTo(centerX + Math.cos(angAnterior)*innerRadius, centerY + Math.sin(angAnterior)*innerRadius);
    ctx.arc(centerX, centerY, innerRadius, angAnterior, 0, true);
    ctx.closePath();
    ctx.fillStyle = '#FFD700';
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, outerRadius, angAnterior, angAnterior+angAtual);
    ctx.lineTo(centerX + Math.cos(angAnterior+angAtual)*innerRadius, centerY + Math.sin(angAnterior+angAtual)*innerRadius);
    ctx.arc(centerX, centerY, innerRadius, angAnterior+angAtual, angAnterior, true);
    ctx.closePath();
    ctx.fillStyle = calcularCrescimento(anterior, atual) >= 0 ? '#0000FF' : '#FF0000';
    ctx.fill();

    ctx.beginPath();
    ctx.arc(centerX, centerY, innerRadius, 0, 2*Math.PI);
    ctx.fillStyle = 'white';
    ctx.fill();

    const crescimento = calcularCrescimento(anterior, atual);
    ctx.fillStyle = crescimento >= 0 ? 'green' : 'red';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(crescimento.toFixed(2) + '%', centerX, centerY);
  }

  function renderizarRelatorios() {
    const relatorios = carregarRelatorios();
    listaRelatoriosEl.innerHTML = '';
    if(relatorios.length === 0){
      listaRelatoriosEl.innerHTML = '<p>Nenhum relatório salvo.</p>';
      return;
    }

    relatorios.forEach((rel, index) => {
      const card = document.createElement('div');
      card.className = 'report-card';

      const crescimento = calcularCrescimento(rel.mesAnterior, rel.mesAtual);
      const isPositivo = crescimento >= 0;

      card.innerHTML = `
        <p><span class="report-header">Mês:</span> ${rel.mes}</p>
        <p><span class="report-header">Filial:</span> ${rel.filial}</p>
        <p><span class="report-header">Classificação:</span> ${rel.classificacao}</p>
        <p><span class="report-header">Região:</span> ${rel.regiao}</p>
        <p><span class="report-header">Sell Out Anterior:</span> ${formatarMoeda(rel.mesAnterior)}</p>
        <p><span class="report-header">Sell Out Atual:</span> ${formatarMoeda(rel.mesAtual)} <span class="icon-arrow">${isPositivo ? '⬆️' : '⬇️'}</span></p>
        <p><span class="report-header">Crescimento:</span> <span class="${isPositivo ? 'growth-positive' : 'growth-negative'}">${crescimento.toFixed(2)}%</span></p>
        <canvas width="200" height="200"></canvas>
        <button class="btn-delete" data-index="${index}">Apagar</button>
      `;
      listaRelatoriosEl.appendChild(card);
      desenharGraficoRosca(card.querySelector('canvas'), rel.mesAnterior, rel.mesAtual);
    });
  }

  function mostrarMensagem(texto, sucesso = true) {
    messageEl.textContent = texto;
    messageEl.className = sucesso ? 'message-success' : 'message-error';
    setTimeout(() => {
      messageEl.textContent = '';
      messageEl.className = '';
    }, 4000);
  }

  // ALTERAÇÃO IMPORTANTE AQUI:
  form.addEventListener('submit', e => {
    e.preventDefault();

    const mes = mesEl.value;

    const filialSelecionadas = Array.from(filialEl.selectedOptions).map(opt => opt.value);
    if (filialSelecionadas.length === 0 || filialSelecionadas.length > 6) {
      mostrarMensagem('Selecione de 1 a 6 filiais.', false);
      return;
    }
    const filial = filialSelecionadas.join(', ');

    const classificacao = classificacaoEl.value;
    const regiao = regiaoEl.value;
    const mesAnterior = mesAnteriorEl.value.trim();
    const mesAtual = mesAtualEl.value.trim();

    if(!mes || !classificacao || !regiao || mesAnterior === '' || mesAtual === ''){
      mostrarMensagem('Por favor, preencha todos os campos corretamente.', false);
      return;
    }

    const anteriorNum = normalizarValor(mesAnterior);
    const atualNum = normalizarValor(mesAtual);

    let relatorios = carregarRelatorios();

    const existe = relatorios.some(r => r.mes === mes && r.filial === filial);
    if(existe){
      mostrarMensagem('Esse relatório já foi salvo.', false);
      return;
    }

    relatorios.push({
      mes,
      filial,
      classificacao,
      regiao,
      mesAnterior: anteriorNum,
      mesAtual: atualNum
    });

    salvarRelatorios(relatorios);
    form.reset();
    mostrarMensagem('Relatório salvo com sucesso!', true);
    renderizarRelatorios();
  });

  listaRelatoriosEl.addEventListener('click', e => {
    if(e.target.matches('.btn-delete')){
      const idx = parseInt(e.target.dataset.index, 10);
      if(!isNaN(idx)){
        let relatorios = carregarRelatorios();
        relatorios.splice(idx, 1);
        salvarRelatorios(relatorios);
        renderizarRelatorios();
      }
    }
  });

  renderizarRelatorios();
</script>
</body>
</html>

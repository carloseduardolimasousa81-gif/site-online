<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel de Visitas - American Pet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root {
      --bg: #f4f4f4;
      --text: #333;
      --primary: #4a90e2;
      --card: #fff;
    }
    [data-theme="dark"] {
      --bg: #121212;
      --text: #eee;
      --primary: #4a90e2;
      --card: #1e1e1e;
    }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
    }
    header {
      background: var(--primary);
      padding: 1rem;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #container {
      display: flex;
      height: calc(100vh - 60px);
    }
    #sidebar {
      width: 280px;
      background: var(--card);
      padding: 1rem;
      overflow-y: auto;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
    }
    #main {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }
    input, select, textarea, button {
      width: 100%;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
    }
    .card {
      background: var(--card);
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }
    .photo-preview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 0.5rem;
    }
    .photo-preview img {
      width: 100%;
      height: auto;
      max-height: 150px;
      object-fit: contain;
      border-radius: 4px;
      cursor: pointer;
    }
    .dark-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }
    #limparTudoBtn {
      background:#555;
      color:white;
      font-size:0.8rem;
      margin-top:auto;
    }
    .modal-foto {
      position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;
    }
    .modal-foto img { max-width:90%; max-height:90%; border-radius:6px; object-fit:contain; }

    /* Bot√£o de apagar discreto */
    .btn-apagar {
      background: transparent;
      color: #e74c3c;
      border: none;
      font-size: 0.9rem;
      padding: 0.2rem 0.4rem;
      cursor: pointer;
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      opacity: 0.6;
      transition: opacity 0.2s;
    }
    .btn-apagar:hover {
      opacity: 1;
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-map-location-dot"></i> Painel de Visitas</h1>
    <button class="dark-toggle" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
  </header>

  <div id="container">
    <aside id="sidebar">
      <h2>Nova Visita</h2>
      <label>Filial:</label>
      <select id="filial">
        <optgroup label="Rede American Pet (AP)">
          <option>AP02 - Jardim Oce√¢nico</option>
          <option>AP03 - Notre Dame</option>
          <option>AP04 - Pau Ferro</option>
          <option>AP05 - Guignard</option>
          <option>AP06 - Barra (Rio Design)</option>
          <option>AP07 - Barra (Shell)</option>
          <option>AP08 - Anil</option>
          <option>AP09 - Pedro Correa</option>
          <option>AP10 - Ilha Guanabara</option>
          <option>AP11 - Copacabana</option>
          <option>AP12 - Taquara</option>
          <option>AP13 - Campo Grande</option>
          <option>AP14 - Gerem√°rio Dantas</option>
          <option>AP15 - Tijuca</option>
          <option>AP16 - Cachamorra</option>
          <option>AP17 - Ilha Dende</option>
          <option>AP18 - Shopping Nova Igua√ßu</option>
          <option>AP19 - Petropolis</option>
          <option>AP20 - Piratininga</option>
          <option>AP21 - Abelardo Bueno</option>
          <option>AP22 - Botafogo</option>
          <option>AP23 - Meier</option>
          <option>AP24 - Vila Isabel</option>
          <option>AP25 - Ipanema</option>
          <option>AP26 - Santa Rosa</option>
          <option>AP27 - Realengo</option>
          <option>AP28 - Recreio Americas</option>
          <option>AP30 - Caxias</option>
          <option>AP31 - Conde de Bonfim</option>
          <option>AP32 - Recreio Gilka</option>
          <option>AP33 - Catete</option>
          <option>AP34 - Cacuia</option>
          <option>AP35 - Nova Igua√ßu Dutra</option>
          <option>AP36 - Copacabana II</option>
          <option>AP37 - Itaipu</option>
          <option>AP39 - Estacio</option>
          <option>AP40 - Bonsucesso</option>
          <option>AP41 - Bangu</option>
          <option>AP42 - Itabora√≠</option>
          <option>AP43 - Petr√≥polis Araras</option>
          <option>AP44 - Campo Grande Monteiro</option>
          <option>AP45 - S√£o Jo√£o de Meriti</option>
          <option>AP47 - Petr√≥polis II</option>
          <option>AP48 - Valqueire</option>
          <option>AP49 - Araruama</option>
          <option>AP50 - Icara√≠</option>
          <option>AP51 - Aerotown</option>
          <option>AP52 - S√£o Pedro da Aldeia</option>
          <option>AP53 - Barra Golf</option>
          <option>AP54 - Cachambi</option>
          <option>AP55 - Itaip√∫ II</option>
          <option>AP56 - Teres√≥polis</option>
          <option>AP57 - Maric√°</option>
          <option>AP58 - Vargem Grande</option>
          <option>AP61 - Pendotiba</option>
        </optgroup>
        <optgroup label="Rede Dom Atacadista / Guanabara / Outras">
          <option>ARARUAMA - VILA CAPRI</option>
          <option>ARARUAMA - CENTRO</option>
          <option>ANGRA DOS REIS - DOM ATACADISTA</option>
          <option>BELFORD ROXO - ATACAD√ÉO</option>
          <option>BUZIOS</option>
          <option>DUQUE DE CAXIAS - PREZUNIC</option>
          <option>DUQUE DE CAXIAS DOM ATACADISTA</option>
          <option>MAG√â</option>
          <option>NOVA IGUA√áU - SUPER BOM</option>
          <option>QUEIMADO - REDE ECONOMIA</option>
          <option>CABO FRIO - CENTRO</option>
          <option>CABO FRIO - S√ÉO CRISTOV√ÉO</option>
          <option>CABO FRIO - JARDIM ESPERAN√áA</option>
          <option>ITABORA√ç - CIDADE NORTE</option>
          <option>ITABORA√ç - MANILHA</option>
          <option>ITABORA√ç - OUTEIRO PEDRAS</option>
          <option>ITABORA√ç - PLAZA SHOPPING</option>
          <option>ITABORA√ç - RIO VARZEA</option>
          <option>ITABORA√ç - TUBAR√ÉO BR101</option>
          <option>ITABORA√ç - VENDA DAS PEDRAS</option>
          <option>MACA√â</option>
          <option>CENTRO - MARIC√Å</option>
          <option>MARIC√Å - PREZUNIC</option>
          <option>SANTA ROSA</option>
          <option>PENDOTIBA</option>
          <option>PIRATININGA</option>
          <option>LARGO DA BATALHA</option>
          <option>ITAIPU</option>
          <option>ICARA√ç II</option>
          <option>ICARA√ç</option>
          <option>FONSECA</option>
          <option>CENTRO II</option>
          <option>CENTRO</option>
          <option>BALDEADOR</option>
          <option>RIO DAS OSTRAS</option>
          <option>TIJUCA - GUANABARA</option>
          <option>PENHA - GUANABARA</option>
          <option>INHA√öMA - DOM ATACADISTA</option>
          <option>GUADALUPE - SHOPPING</option>
          <option>CAMPINHO - GUANABARA</option>
          <option>G√ÅVEA</option>
          <option>BOTAFOGO</option>
          <option>URCA</option>
          <option>COPACABANA - RONALD DE CARVALHO</option>
          <option>COPACABANA - SANTA CLARA</option>
          <option>CIDADE DE DEUS - PREZUNIC</option>
          <option>RECREIO DOS BANDEIRANTES</option>
          <option>TANQUE GUANABARA</option>
          <option>SANTA CRUZ - PREZUNIC</option>
          <option>FREGUESIA - MUNDIAL</option>
          <option>CURICICA - MUNDIAL</option>
          <option>CAMPO GRANDE - SUPER BOM</option>
          <option>CAMPO GRANDE - GUANABARA</option>
          <option>BACAX√Å TREVO - SAQUAREMA</option>
          <option>BACAX√Å CENTRO - SAQUAREMA</option>
          <option>VISTA ALEGRE - COSTA AZUL</option>
          <option>TRINDADE</option>
          <option>SANTA CATARINA</option>
          <option>ROCHA</option>
          <option>PARA√çSO</option>
          <option>JARDIM ALC√ÇNTARA COSTAZUL</option>
          <option>GUANABARA - S√ÉO CON√áALO</option>
          <option>CENTRO - S√ÉO GON√áALO</option>
          <option>CEASA - S√ÉO GON√áALO</option>
          <option>ALC√ÇTARA RAUL VEIGA</option>
          <option>ALC√ÇTARA CARREFOUR</option>
          <option>ALC√ÇTARA CENTRO</option>
          <option>UBATUBA - SHIBATA</option>
          <option>SUZANO - SHIBATA</option>
          <option>PINDAMONHANGABA - SHIBATA</option>
          <option>CRUZEIRO</option>
          <option>TAUBAT√â</option>
          <option>PRA BICHO ANDARA√ç</option>
          <option>PRA BICHO VISTA ALEGRE</option>
          <option>PRA BICHO FLAMENGO</option>
          <option>PRA BICHO ROCHA MIRANDA</option>
          <option>PRA BICHO ILHA DO GOVERNADOR</option>
          <option>MANIA DE BICHO</option>
          <option>MANIA DE BICHO II</option>
          <option>MAIS QUE PET</option>
          <option>CENTAL DOS BICHOS</option>
          <option>MUNDO ANIMAL</option>
          <option>4 PATAS ITAIPU</option>
        </optgroup>
      </select>

      <label>Regi√£o:</label>
      <select id="regiao">
        <option>BAIXADA</option>
        <option>BARRA</option>
        <option>RECREIO</option>
        <option>LAGOS</option>
        <option>NITER√ìI</option>
        <option>OCE√ÇNICA</option>
        <option>NORTE</option>
        <option>NORTE FLUMINENSE</option>
        <option>OESTE</option>
        <option>S√ÉO GON√áALO</option>
        <option>S√ÉO PAULO</option>
        <option>SERRANA</option>
        <option>COSTA VERDE</option>
        <option>SUL</option>
        <option>TIJUCA</option>
      </select>

      <label>Data:</label>
      <input id="data" type="date" />

      <label>Observa√ß√µes:</label>
      <textarea id="observacoes"></textarea>

      <label>Layout N&D:</label>
      <select id="layoutND">
        <option value="sim">SIM</option>
        <option value="nao">N√ÉO</option>
      </select>

      <label>Layout Vet LIFE:</label>
      <select id="layoutVetLife">
        <option value="sim">SIM</option>
        <option value="nao">N√ÉO</option>
      </select>

      <label>Fotos:</label>
      <input id="fotos" type="file" multiple accept="image/*" />

      <button onclick="salvarVisita()">Salvar Visita</button>

      <h2>Filtrar</h2>
      <label>Filtrar por regi√£o:</label>
      <select id="filtroRegiao" onchange="carregarVisitas()">
        <option value="">Todas</option>
        <option>BAIXADA</option>
        <option>BARRA</option>
        <option>RECREIO</option>
        <option>LAGOS</option>
        <option>NITER√ìI</option>
        <option>OCE√ÇNICA</option>
        <option>NORTE</option>
        <option>NORTE FLUMINENSE</option>
        <option>OESTE</option>
        <option>S√ÉO GON√áALO</option>
        <option>S√ÉO PAULO</option>
        <option>SERRANA</option>
        <option>COSTA VERDE</option>
        <option>SUL</option>
        <option>TIJUCA</option>
      </select>

      <button id="limparTudoBtn" onclick="limparTudo()">Limpar Tudo</button>
    </aside>

    <main id="main">
      <h2>Visitas Cadastradas</h2>
      <div id="painel"></div>
      <canvas id="grafico" width="600" height="300"></canvas>
    </main>
  </div>

  <script>
    if (window.Chart && window.ChartDataLabels) Chart.register(ChartDataLabels);

    let db;
    const request = indexedDB.open("VisitasDB", 1);
    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("visitas")) {
        db.createObjectStore("visitas", { keyPath: "id", autoIncrement: true });
      }
    };
    request.onsuccess = e => {
      db = e.target.result;
      carregarVisitas();
    };
    request.onerror = e => {
      console.error("Erro ao abrir IndexedDB:", e);
      alert("Erro ao abrir o banco local. Verifique o console.");
    };

    function toggleTheme() {
      const atual = document.documentElement.getAttribute("data-theme");
      document.documentElement.setAttribute("data-theme", atual === "dark" ? "light" : "dark");
    }

    function salvarVisita() {
      if (!db) {
        alert("Banco de dados n√£o est√° pronto. Aguarde um instante e tente novamente.");
        return;
      }

      const filial = document.getElementById("filial").value.trim();
      const regiao = document.getElementById("regiao").value;
      const data = document.getElementById("data").value;
      const obs = document.getElementById("observacoes").value;
      const layoutND = document.getElementById("layoutND").value;
      // CORRE√á√ÉO: nome da vari√°vel consistente
      const layoutVetLife = document.getElementById("layoutVetLife").value;
      const arquivos = document.getElementById("fotos").files;

      if (!filial || arquivos.length === 0) {
        alert("Preencha o campo Filial e selecione ao menos uma foto.");
        return;
      }

      // L√™ at√© 6 imagens como DataURL
      const leitor = Array.from(arquivos).slice(0, 6).map(file => new Promise(resolve => {
        const r = new FileReader();
        r.onload = e => resolve(e.target.result);
        r.onerror = () => resolve(null);
        r.readAsDataURL(file);
      }));

      Promise.all(leitor).then(fotos => {
        // filtra poss√≠veis nulls
        fotos = fotos.filter(Boolean);

        const tx = db.transaction("visitas", "readwrite");
        const store = tx.objectStore("visitas");
        store.add({ filial, regiao, data, obs, fotos, layoutND, layoutVetLife });
        tx.oncomplete = () => {
          // limpa inputs depois de salvar
          document.getElementById("observacoes").value = "";
          document.getElementById("fotos").value = null;
          carregarVisitas();
        };
        tx.onerror = (ev) => {
          console.error("Erro salvando visita:", ev);
          alert("Falha ao salvar visita. Veja o console para detalhes.");
        };
      }).catch(err => {
        console.error("Erro ao ler arquivos:", err);
        alert("Falha ao ler as imagens selecionadas.");
      });
    }

    function carregarVisitas() {
      const painel = document.getElementById("painel");
      painel.innerHTML = "";
      const filtro = document.getElementById("filtroRegiao").value;
      const visitas = [];

      if (!db) {
        painel.innerHTML = "<p>Banco de dados n√£o dispon√≠vel.</p>";
        return;
      }

      const tx = db.transaction("visitas", "readonly");
      const store = tx.objectStore("visitas");
      const requestCursor = store.openCursor();

      requestCursor.onsuccess = e => {
        const cursor = e.target.result;
        if (cursor) {
          const v = cursor.value;
          if (!filtro || v.regiao === filtro) visitas.push(v);
          cursor.continue();
        } else {
          // ordena por id descendente para mostrar as visitas mais recentes primeiro
          visitas.sort((a,b) => (b.id || 0) - (a.id || 0));
          visitas.forEach(v => {
            const iconND = v.layoutND === "sim" ? "üëç" : "üëé";
            const iconVet = v.layoutVetLife === "sim" ? "üëç" : "üëé";
            const div = document.createElement("div");
            div.className = "card";

            // header
            const header = document.createElement("div");
            header.innerHTML = `<strong>${v.filial}</strong> <em>(${v.regiao})</em><br/><small>${v.data}</small>`;
            div.appendChild(header);

            // observa√ß√µes
            if (v.obs) {
              const p = document.createElement("p");
              p.textContent = v.obs;
              div.appendChild(p);
            }

            // fotos
            const preview = document.createElement("div");
            preview.className = "photo-preview";
            if (Array.isArray(v.fotos) && v.fotos.length) {
              v.fotos.forEach((f, idx) => {
                const img = document.createElement("img");
                img.src = f;
                img.alt = `Foto ${idx+1}`;
                img.addEventListener("click", (ev) => {
                  ev.stopPropagation();
                  abrirModal(idx, v.fotos);
                });
                preview.appendChild(img);
              });
            } else {
              preview.innerHTML = "<small>Nenhuma foto</small>";
            }
            div.appendChild(preview);

            // indicadores layout
            const layoutDiv = document.createElement("div");
            layoutDiv.style.marginTop = "0.5rem";
            layoutDiv.innerHTML = `Layout N&D: ${iconND}<br/>Layout Vet LIFE: ${iconVet}`;
            div.appendChild(layoutDiv);

            // bot√£o apagar
            const apagar = document.createElement("button");
            apagar.className = "btn-apagar";
            apagar.textContent = "üóëÔ∏è";
            apagar.addEventListener("click", (ev) => {
              ev.stopPropagation();
              apagarVisita(v.id);
            });
            div.appendChild(apagar);

            painel.appendChild(div);
          });

          desenharGrafico(visitas);
        }
      };

      requestCursor.onerror = e => {
        console.error("Erro ao ler visitas:", e);
      };
    }

    function apagarVisita(id) {
      if (!confirm("Deseja realmente apagar esta visita?")) return;
      const tx = db.transaction("visitas", "readwrite");
      const store = tx.objectStore("visitas");
      const req = store.delete(id);
      req.onsuccess = () => carregarVisitas();
      req.onerror = (e) => {
        console.error("Erro ao apagar visita:", e);
        alert("Falha ao apagar visita.");
      };
    }

    function abrirModal(startIndex = 0, fotos = []) {
      let fotoIndex = startIndex;
      if (!Array.isArray(fotos)) fotos = [fotos];

      const modal = document.createElement("div");
      modal.className = "modal-foto";

      const img = document.createElement("img");
      img.src = fotos[fotoIndex];
      modal.appendChild(img);

      if (fotos.length > 1) {
        const setaEsq = document.createElement("span");
        setaEsq.innerText = "‚üµ";
        setaEsq.style.cssText = "position:absolute;top:50%;left:20px;font-size:3rem;color:white;cursor:pointer;user-select:none;transform:translateY(-50%);";
        setaEsq.onclick = (e) => { e.stopPropagation(); fotoIndex = (fotoIndex - 1 + fotos.length) % fotos.length; img.src = fotos[fotoIndex]; };
        modal.appendChild(setaEsq);

        const setaDir = document.createElement("span");
        setaDir.innerText = "‚ü∂";
        setaDir.style.cssText = "position:absolute;top:50%;right:20px;font-size:3rem;color:white;cursor:pointer;user-select:none;transform:translateY(-50%);";
        setaDir.onclick = (e) => { e.stopPropagation(); fotoIndex = (fotoIndex + 1) % fotos.length; img.src = fotos[fotoIndex]; };
        modal.appendChild(setaDir);
      }

      modal.onclick = () => modal.remove();
      document.body.appendChild(modal);
    }

    let grafico;
    function desenharGrafico(visitas) {
      const ctx = document.getElementById("grafico").getContext("2d");
      const regioes = [...new Set(visitas.map(v => v.regiao))];
      const dados = regioes.map(r => visitas.filter(v => v.regiao === r).length);

      const backgroundColors = dados.map(qtd => {
        if (qtd === 0) return 'rgba(189, 195, 199, 0.8)';
        if (qtd >= 1 && qtd <= 3) return 'rgba(231, 76, 60, 0.9)';
        if (qtd >= 4 && qtd <= 6) return 'rgba(241, 196, 15, 0.95)';
        if (qtd >= 7 && qtd <= 9) return 'rgba(46, 204, 113, 0.9)';
        return 'rgba(52, 152, 219, 0.9)';
      });

      const labelColors = backgroundColors.map(bg => {
        if (bg.includes('241, 196, 15')) return '#000';
        if (bg.includes('189, 195, 199')) return '#000';
        return '#ffffff';
      });

      if (grafico) grafico.destroy();

      grafico = new Chart(ctx, {
        type: 'bar',
        data: { labels: regioes, datasets: [{ label: 'N√∫mero de Visitas', data: dados, backgroundColor: backgroundColors, borderRadius: 6 }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false }, datalabels: { anchor: 'center', align: 'center', formatter: value => value, color: function(context){return labelColors[context.dataIndex] || '#fff';}, font: { weight: '700', size: 12 } } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        },
        plugins: [ChartDataLabels]
      });
    }

    function limparTudo() {
      if (!confirm("Deseja realmente apagar todas as visitas? Esta a√ß√£o n√£o pode ser desfeita.")) return;
      const tx = db.transaction("visitas", "readwrite");
      const store = tx.objectStore("visitas");
      const clearRequest = store.clear();
      clearRequest.onsuccess = () => { alert("Todas as visitas foram apagadas."); carregarVisitas(); };
      clearRequest.onerror = () => alert("Erro ao tentar limpar as visitas.");
    }
  </script>
</body>
</html>

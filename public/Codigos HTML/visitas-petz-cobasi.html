<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Panorama de Visitas</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: #f9fafb;
      padding: 20px;
      max-width: 960px;
      margin: 0 auto;
      color: #333;
      line-height: 1.5;
    }

    h3, h4 {
      color: #1e293b;
      margin-bottom: 12px;
      font-weight: 500;
    }

    form, .card {
      background: #fff;
      padding: 20px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.08);
      margin-bottom: 20px;
      transition: box-shadow 0.3s ease;
    }

    form:hover, .card:hover {
      box-shadow: 0 6px 16px rgb(0 0 0 / 0.12);
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 6px;
      color: #475569;
    }

    select, input[type="date"], textarea, input[type="text"], input[type="file"] {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 16px;
      border: 1.5px solid #cbd5e1;
      border-radius: 8px;
      font-size: 1rem;
      color: #334155;
      background-color: #f8fafc;
      transition: border-color 0.2s ease;
    }

    select:focus, input[type="date"]:focus, textarea:focus, input[type="text"]:focus, input[type="file"]:focus {
      border-color: #2563eb;
      outline: none;
      background-color: #fff;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
      font-family: 'Roboto', Arial, sans-serif;
    }

    button {
      font-weight: 600;
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    .btn-save {
      background-color: #16a34a;
      color: white;
      box-shadow: 0 3px 8px rgb(22 163 74 / 0.5);
    }

    .btn-save:hover {
      background-color: #15803d;
      box-shadow: 0 4px 14px rgb(21 128 61 / 0.7);
    }

    .btn-del {
      background-color: #dc2626;
      color: white;
      float: right;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 700;
      box-shadow: 0 3px 8px rgb(220 38 38 / 0.5);
      border: none;
      line-height: 1;
      transition: background-color 0.3s ease;
    }

    .btn-del:hover {
      background-color: #991b1b;
      box-shadow: 0 4px 14px rgb(153 27 27 / 0.7);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(280px,1fr));
      gap: 16px;
    }

    /* Fotos preview (upload) e no relatório com proporção melhor */
    .fotos-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
    }

    .fotos-preview img {
      width: auto;
      height: 140px; /* altura fixa */
      max-width: 210px; /* limite largura para manter proporção */
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      background: #fff;
      box-shadow: 0 1px 4px rgb(0 0 0 / 0.1);
      object-fit: cover;
      transition: transform 0.2s ease;
    }

    .fotos-preview img:hover {
      transform: scale(1.05);
      box-shadow: 0 3px 12px rgb(0 0 0 / 0.15);
    }

    .ruptura {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
    }

    .ruptura input {
      flex: 1 1 30%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1.5px solid #cbd5e1;
      background: #f8fafc;
      font-size: 0.9rem;
      color: #334155;
      transition: border-color 0.2s ease;
    }

    .ruptura input:focus {
      border-color: #2563eb;
      outline: none;
      background-color: #fff;
    }

    ul {
      margin-top: 8px;
      padding-left: 20px;
      color: #475569;
    }

    ul li {
      margin-bottom: 4px;
      font-size: 0.95rem;
    }

    button[type="button"] {
      background-color: #2563eb;
      color: white;
      margin-top: 8px;
      padding: 10px 16px;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgb(37 99 235 / 0.5);
      font-weight: 600;
      transition: background-color 0.3s ease;
    }

    button[type="button"]:hover {
      background-color: #1e40af;
      box-shadow: 0 4px 14px rgb(30 64 175 / 0.7);
    }

    @media (max-width: 720px) {
      .ruptura input {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <form id="visitaForm" autocomplete="off">
    <h3>Nova Visita</h3>
    <label for="nome">Loja:</label>
    <select id="nome" name="nome" required>
      <option value="">Selecione</option>
      <option>Petz - Ilha do Governador</option>
      <option>Petz - Bangu</option>
      <option>Petz - Campo Grande</option>
      <option>Petz - Niterói</option>
      <option>Petz - São Gonçalo (Manilha)</option>
      <option>Cobasi - Campo Grande</option>
      <option>Cobasi - Niterói</option>
      <option>Cobasi - ParkShopping Jacarepaguá</option>
      <option>Petz - Abelardo Bueno</option>
      <option>Cobasi - Abelardo Bueno</option>
      <option>Cobasi Carrefour Barra</option>
      <option>Cobasi Shopping Via Parque</option>
    </select>

    <label for="regiao">Região:</label>
    <select id="regiao" name="regiao" required>
      <option value="">Selecione</option>
      <option value="ILHA">Ilha</option>
      <option value="OESTE">Zona Oeste</option>
      <option value="Z. NORTE">Zona Norte</option>
      <option value="NIT">Niterói</option>
      <option value="SUL">Zona Sul</option>
      <option value="JPA">Jacarepaguá</option>
      <option value="TIJUCA">Tijuca</option>
      <option value="SG">São Gonçalo</option>
      <option value="BARRA">Barra</option>
    </select>

    <label for="data">Data:</label>
    <input type="date" id="data" name="data" required>

    <label for="comentario">Comentário:</label>
    <textarea id="comentario" name="comentario" rows="2" placeholder="Opcional"></textarea>

    <label for="fotos">Fotos:</label>
    <input type="file" id="fotos" name="fotos" multiple accept="image/*">

    <div class="fotos-preview" id="preview"></div>

    <div id="rupturas">
      <h4>Rupturas</h4>
    </div>
    <button type="button" onclick="adicionarRuptura()">+ Adicionar Ruptura</button>

    <br><br>
    <button type="submit" class="btn-save">Salvar Visita</button>
  </form>

  <div id="visitas" class="grid"></div>

  <script>
    const form = document.getElementById('visitaForm');
    const preview = document.getElementById('preview');
    const visitasDiv = document.getElementById('visitas');
    const rupturasDiv = document.getElementById('rupturas');
    let visitas = [];

    const regioesPorExtenso = {
      ILHA: 'Ilha do Governador',
      OESTE: 'Zona Oeste',
      'Z. NORTE': 'Zona Norte',
      NIT: 'Niterói',
      SUL: 'Zona Sul',
      JPA: 'Jacarepaguá',
      TIJUCA: 'Tijuca',
      SG: 'São Gonçalo',
      BARRA: 'Barra'
    };

    form.data.value = new Date().toISOString().split('T')[0];

    form.fotos.addEventListener('change', (e) => {
      preview.innerHTML = '';
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.createElement('img');
          img.src = event.target.result;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    function adicionarRuptura() {
      const div = document.createElement('div');
      div.className = 'ruptura';
      div.innerHTML = `
        <input type="text" placeholder="EAN" />
        <input type="text" placeholder="Código" />
        <input type="text" placeholder="Produto" />
      `;
      rupturasDiv.appendChild(div);
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const files = form.fotos.files;
      const rupturas = Array.from(document.querySelectorAll('.ruptura')).map(div => {
        const inputs = div.querySelectorAll('input');
        return {
          ean: inputs[0].value.trim(),
          codigo: inputs[1].value.trim(),
          descricao: inputs[2].value.trim()
        };
      }).filter(r => r.ean || r.codigo || r.descricao);

      const visita = {
        id: Date.now(),
        nome: formData.get('nome'),
        regiao: formData.get('regiao'),
        data: formData.get('data'),
        comentario: formData.get('comentario').trim(),
        fotos: [],
        rupturas
      };

      const readerPromises = Array.from(files).map(file => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.readAsDataURL(file);
        });
      });

      Promise.all(readerPromises).then(imgs => {
        visita.fotos = imgs;
        visitas.push(visita);
        try {
          localStorage.setItem('visitasPETZCOBASI', JSON.stringify(visitas));
        } catch {
          alert('Erro ao salvar: limite de armazenamento excedido.');
        }
        renderVisitas();
        form.reset();
        preview.innerHTML = '';
        document.querySelectorAll('.ruptura').forEach(r => r.remove());
        form.data.value = new Date().toISOString().split('T')[0];
      });
    });

    function renderVisitas() {
      visitasDiv.innerHTML = '';
      visitas.forEach(visita => {
        const card = document.createElement('div');
        card.className = 'card';
        const regiaoCompleta = regioesPorExtenso[visita.regiao] || visita.regiao;
        card.innerHTML = `
          <button class="btn-del" aria-label="Deletar visita" onclick="deletar(${visita.id})">×</button>
          <h4>${visita.nome}</h4>
          <p><strong>${regiaoCompleta} - RJ</strong></p>
          <p>${visita.data}</p>
          ${visita.comentario ? `<p><em>"${visita.comentario}"</em></p>` : ''}
          <div class="fotos-preview">
            ${visita.fotos.map(f => `<img src="${f}" alt="Foto da visita">`).join('')}
          </div>
          ${visita.rupturas.length ? `<div><strong>Rupturas:</strong><ul>${visita.rupturas.map(r => `<li>${r.ean} - ${r.codigo} - ${r.descricao}</li>`).join('')}</ul></div>` : ''}
        `;
        visitasDiv.appendChild(card);
      });
    }

    function deletar(id) {
      visitas = visitas.filter(v => v.id !== id);
      try {
        localStorage.setItem('visitasPETZCOBASI', JSON.stringify(visitas));
      } catch {
        alert('Erro ao atualizar dados.');
      }
      renderVisitas();
    }

    try {
      visitas = JSON.parse(localStorage.getItem('visitasPETZCOBASI') || '[]');
    } catch {
      visitas = [];
    }

    renderVisitas();
  </script>
</body>
</html>

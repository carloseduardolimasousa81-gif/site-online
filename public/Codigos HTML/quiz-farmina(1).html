<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz Farmina - Balconistas</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
    h1 { text-align: center; color: #333; }
    .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .btn { margin: 5px; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
    .btn-blue { background: #007BFF; color: white; }
    .btn-red { background: #dc3545; color: white; }
    .btn-gray { background: #6c757d; color: white; }
    .btn-green { background: #28a745; color: white; padding: 10px; display: inline-block; margin-top: 10px; }
    .input { display: block; width: 100%; margin: 10px 0; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
    .img-resposta { max-width: 100%; margin-top: 10px; border-radius: 5px; }
    #cronometro { font-size: 24px; font-weight: bold; margin: 10px 0; color: #dc3545; text-align: center; }
    #ranking { background: #fff; padding: 20px; border-radius: 10px; margin-top: 20px; }
    #ranking h2 { color: #333; }
    #ranking ul { padding-left: 20px; }
  </style>
</head>
<body>

<h1>üéØ Quiz Farmina - Balconistas</h1>

<input class="input" id="nomeInput" placeholder="Digite o nome do participante e pressione Enter" 
  onkeypress="if(event.key==='Enter') adicionarNome()" />
<button class="btn btn-red" onclick="reiniciarQuiz()">üîÑ Reiniciar Quiz</button>
<button class="btn btn-gray" onclick="toggleModoEdicao()">‚úèÔ∏è Alternar Edi√ß√£o</button>
<button class="btn btn-blue" onclick="mostrarRanking()">üèÜ Ver Ranking Final</button>

<div id="listaParticipantes" style="margin-bottom:10px; font-weight:bold;"></div>

<div id="cronometro"></div>
<div id="quiz-container"></div>
<div id="navegacao" style="margin-top:20px;"></div>
<div id="ranking"></div>

<audio id="alarme" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
// Perguntas persistem
let perguntas = JSON.parse(localStorage.getItem('quizPerguntas')) || Array.from({length: 10}, (_, i) => ({
  id: i + 1, texto: '', correta: '', incorreta1: '', incorreta2: '', imagem: ''
}));

// Nomes N√ÉO persistem
let nomesParticipantes = [];
let nomesDisponiveis = [];
let sorteios = {};

// Pontua√ß√£o PERSISTE
let pontuacao = JSON.parse(localStorage.getItem('quizPontuacao')) || {};
let perguntaAtual = 0;
let mostrarResposta = {};
let modoEdicao = false;
let tempo = 60;
let intervalo;
let ultimaPessoaFalada = null;

// Salvar apenas perguntas e pontua√ß√£o
function salvar() {
  localStorage.setItem('quizPerguntas', JSON.stringify(perguntas));
  localStorage.setItem('quizPontuacao', JSON.stringify(pontuacao));
}

// Adicionar participante
function adicionarNome() {
  const input = document.getElementById('nomeInput');
  const nome = input.value.trim();
  if(nome && !nomesParticipantes.includes(nome)){
    nomesParticipantes.push(nome);
    nomesDisponiveis = [...nomesParticipantes];
    mostrarListaParticipantes();
    renderizarQuiz();
  }
  input.value = "";
}

// Mostrar participantes
function mostrarListaParticipantes() {
  const div = document.getElementById('listaParticipantes');
  div.innerHTML = 'Participantes: ' + nomesParticipantes.join(', ');
}

// Sortear participante
function sortearPessoa(id) {
  if (!sorteios[id]) {
    if (nomesDisponiveis.length === 0) nomesDisponiveis = [...nomesParticipantes];
    const index = Math.floor(Math.random() * nomesDisponiveis.length);
    const sorteado = nomesDisponiveis.splice(index, 1)[0];
    sorteios[id] = sorteado;
    iniciarCronometro();
    ultimaPessoaFalada = null;
  }
  return sorteios[id];
}

// Cron√¥metro
function iniciarCronometro() {
  tempo = 60;
  atualizarCronometro();
  clearInterval(intervalo);
  intervalo = setInterval(() => {
    tempo--;
    atualizarCronometro();
    if (tempo <= 0) {
      document.getElementById('alarme').play();
      alert("‚è∞ Tempo esgotado! Novo participante ser√° sorteado.");
      delete sorteios[perguntas[perguntaAtual].id];
      renderizarQuiz();
    }
  }, 1000);
}

function atualizarCronometro() {
  document.getElementById('cronometro').innerText = `‚è±Ô∏è Tempo: ${tempo}s`;
}

// Reiniciar quiz
function reiniciarQuiz() {
  nomesParticipantes = [];
  nomesDisponiveis = [];
  sorteios = {};
  mostrarResposta = {};
  perguntaAtual = 0;
  ultimaPessoaFalada = null;
  clearInterval(intervalo);
  document.getElementById('ranking').innerHTML = '';
  mostrarListaParticipantes();
  renderizarQuiz();
}

// Alternar modo edi√ß√£o
function toggleModoEdicao() {
  modoEdicao = !modoEdicao;
  renderizarQuiz();
}

// Embaralhar alternativas
function embaralharAlternativas(p) {
  return [
    { texto: p.correta, correta: true },
    { texto: p.incorreta1, correta: false },
    { texto: p.incorreta2, correta: false }
  ].sort(() => Math.random() - 0.5);
}

// Mostrar e salvar imagem
function mostrarImagem(e, id) {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const maxW = 500;
      const scale = Math.min(maxW / img.width, 1);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      perguntas[id].imagem = canvas.toDataURL('image/jpeg', 0.7); 
      salvar();
      renderizarQuiz();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(file);
}

// Falar texto
function falarTexto(texto) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(texto);
  utterance.lang = 'pt-BR';
  window.speechSynthesis.speak(utterance);
}

// Responder alternativa
function responder(alternativa) {
  const p = perguntas[perguntaAtual];
  const nome = sorteios[p.id];
  if (alternativa.correta) {
    mostrarResposta[p.id] = true;
    pontuacao[nome] = (pontuacao[nome] || 0) + 1;
    salvar();
    clearInterval(intervalo);
    if (window.speechSynthesis) {
      window.speechSynthesis.cancel();
      setTimeout(() => { falarTexto(`Resposta correta: ${p.correta}`); }, 300);
    }
    renderizarQuiz();
    if (Object.keys(mostrarResposta).length === perguntas.length) mostrarRanking();
  } else {
    alert("‚ùå Resposta errada! Outro participante tentar√°.");
    delete sorteios[p.id];
    renderizarQuiz();
  }
}

// Ranking apenas participantes da rodada atual
function mostrarRanking() {
  const ranking = nomesParticipantes
    .filter(nome => pontuacao[nome] > 0)
    .sort((a,b) => pontuacao[b] - pontuacao[a]);

  let html = '<h2>üèÜ Ranking da Rodada</h2><ul>';
  ranking.forEach(nome => html += `<li>${nome} - ${pontuacao[nome]} acerto(s)</li>`);
  html += '</ul>';

  document.getElementById('ranking').innerHTML = html;
}

// Renderizar quiz
function renderizarQuiz() {
  const container = document.getElementById('quiz-container');
  container.innerHTML = '';
  const p = perguntas[perguntaAtual];
  const nome = sortearPessoa(p.id);

  const card = document.createElement('div');
  card.className = 'card';

  if (modoEdicao) {
    card.innerHTML = `
      <h3>Pergunta #${p.id}</h3>
      <input class="input" placeholder="Texto da pergunta" value="${p.texto}" onchange="perguntas[${perguntaAtual}].texto=this.value;salvar()" />
      <input class="input" placeholder="Resposta correta" value="${p.correta}" onchange="perguntas[${perguntaAtual}].correta=this.value;salvar()" />
      <input class="input" placeholder="Alternativa incorreta 1" value="${p.incorreta1}" onchange="perguntas[${perguntaAtual}].incorreta1=this.value;salvar()" />
      <input class="input" placeholder="Alternativa incorreta 2" value="${p.incorreta2}" onchange="perguntas[${perguntaAtual}].incorreta2=this.value;salvar()" />
      <input class="input" type="file" accept="image/*" onchange="mostrarImagem(event, ${perguntaAtual})" />
      ${p.imagem ? `<img src="${p.imagem}" class="img-resposta" />` : ''}
    `;
  } else {
    card.innerHTML = `<h2>${p.texto || 'Pergunta ' + p.id}</h2><p><strong>Participante:</strong> ${nome}</p>`;

    if (!mostrarResposta[p.id]) {
      const alt = embaralharAlternativas(p);
      alt.forEach(a => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-blue';
        btn.innerText = a.texto;
        btn.onclick = () => responder(a);
        card.appendChild(btn);
      });
    } else {
      card.innerHTML += `<p class="btn-green">‚úÖ Resposta correta: ${p.correta}</p>`;
      if (p.imagem) {
        // Corrige visualiza√ß√£o da imagem da √∫ltima pergunta
        card.innerHTML += `<img src="${p.imagem}" class="img-resposta" alt="Imagem da resposta" />`;
      }
    }
  }

  container.appendChild(card);

  document.getElementById('navegacao').innerHTML = `
    <button class="btn btn-gray" onclick="perguntaAtual=Math.max(0,perguntaAtual-1);renderizarQuiz()">‚¨Ö Anterior</button>
    <button class="btn btn-blue" onclick="perguntaAtual=Math.min(perguntas.length-1,perguntaAtual+1);renderizarQuiz()">Pr√≥xima ‚û°</button>
  `;

  if (!modoEdicao && p.texto && nome !== ultimaPessoaFalada) {
    falarTexto(p.texto);
    ultimaPessoaFalada = nome;
  }
}

renderizarQuiz();
</script>
</body>
</html>

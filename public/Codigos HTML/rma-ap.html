<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dashboard RMA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#2dd4bf; --accent-2:#60a5fa;
  --glass: rgba(255,255,255,0.03); --glass-2: rgba(255,255,255,0.02);
}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#071023 0%, #051827 100%);color:#e6eef6}
.app{display:flex;height:100vh;gap:20px;padding:28px}
.sidebar{width:320px;background:linear-gradient(180deg,var(--card),#061226);border-radius:14px;padding:20px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
.brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#021024;font-size:16px}
h1{font-size:18px;margin:0}
.muted{color:var(--muted);font-size:13px;margin-top:4px}
.controls{margin-top:18px}
.filter{background:var(--glass);padding:12px;border-radius:10px;margin-bottom:12px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input[type="text"],input[type="number"],input[type="date"],select{width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
.btn{display:inline-block;padding:10px 12px;border-radius:10px;background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#021024;font-weight:600;border:0;cursor:pointer}
.small{font-size:12px;color:var(--muted)}
.main{flex:1;display:flex;flex-direction:column;gap:18px}
.header{display:flex;justify-content:space-between;align-items:center}
.summary{display:flex;gap:16px;align-items:center}
.kpi{background:var(--glass-2);padding:14px;border-radius:12px;min-width:160px;text-align:center}
.kpi h3{margin:0;font-size:13px;color:var(--muted)}
.kpi p{margin:6px 0 0;font-size:20px;font-weight:700}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.6);min-height:200px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
.card h4{margin:0 0 6px 0;font-size:14px;text-align:center}
.meta{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
.last-saved{font-size:12px;color:var(--muted);margin-top:6px}
.clear-btn{position:absolute;top:6px;right:6px;padding:2px 6px;font-size:10px;background:rgba(255,255,255,0.05);color:#ef4444;border:none;border-radius:6px;cursor:pointer}
.clear-btn:hover{background:rgba(255,255,255,0.12);}
@media (max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
@media (max-width:700px){.app{flex-direction:column;padding:12px}.sidebar{width:100%;order:2}.main{order:1}.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">RMA</div>
      <div>
        <h1>Dashboard RMA</h1>
        <div class="muted">Gerencie seus produtos</div>
      </div>
    </div>

    <div class="controls">
      <div class="filter">
        <label>Filial</label>
        <input id="inputFilial" type="text" placeholder="Ex: Loja 01">
      </div>

      <div class="filter">
        <label>Data de Vencimento</label>
        <input id="inputDate" type="date"/>
      </div>

      <div class="filter">
        <label>Produto</label>
        <input id="inputProduto" type="text"/>
      </div>

      <div class="filter">
        <label>Peso (kg)</label>
        <select id="inputPeso">
          <option value="0.07">0,07</option><option value="0.08">0,08</option><option value="0.085">0,085</option>
          <option value="0.14">0,14</option><option value="0.3">0,3</option><option value="0.4">0,4</option>
          <option value="0.8">0,8</option><option value="1">1</option><option value="1.5">1,5</option>
          <option value="2">2</option><option value="2.5">2,5</option><option value="3">3</option>
          <option value="7">7</option><option value="7.5">7,5</option><option value="10.1">10,1</option>
          <option value="12">12</option><option value="15">15</option><option value="20">20</option>
          <option value="25">25</option>
        </select>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="btnAdd">Adicionar / Atualizar</button>
        <button class="btn" id="btnExport" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent-2)">Exportar JSON</button>
      </div>

      <div style="margin-top:10px">
        <input type="file" id="importFile" accept="application/json" style="display:none"/>
        <label for="importFile" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent-2);cursor:pointer">Importar JSON</label>
      </div>

      <div class="filter" style="margin-top:15px">
        <label>Filtro de Visualização</label>
        <select id="viewFilter">
          <option value="PRODUTO">Por Produto</option>
          <option value="FILIAL">Por Filial</option>
        </select>
      </div>

      <div id="lastSaved" class="last-saved">Último salvamento: —</div>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div class="summary">
        <div class="kpi"><h3>Total RMA</h3><p id="totalRMA">0</p></div>
        <div class="kpi"><h3>Peso Total</h3><p id="pesoTotal">0</p></div>
        <div class="kpi"><h3>Vencidos</h3><p id="totalVencidos">0</p></div>
      </div>
    </div>
    <section class="grid" id="cardsGrid"></section>
  </main>
</div>

<script>
const $ = id => document.getElementById(id);
let rmaData = JSON.parse(localStorage.getItem('rmaData')||'[]');
let charts = {};

// Calcula faixa de vencimento
function calculaVencimento(dataVenc){
  const hoje = new Date();
  const venc = new Date(dataVenc);
  const diffDias = Math.ceil((venc-hoje)/(1000*60*60*24));
  if(diffDias<0) return 'VENCIDOS';
  if(diffDias<=30) return 'TRINTA';
  if(diffDias<=60) return 'SESSENTA';
  if(diffDias<=90) return 'NOVENTA';
  return 'MAIS';
}

// Cor baseada no peso total
function corPorPeso(pesoTotal){
  if(pesoTotal <= 30) return '#10b981'; // verde
  if(pesoTotal <= 60) return '#facc15'; // amarelo
  return '#ef4444'; // vermelho
}

// Salvar dados
function saveData(){
  localStorage.setItem('rmaData', JSON.stringify(rmaData));
  $('lastSaved').textContent = 'Último salvamento: ' + new Date().toLocaleString('pt-BR');
  renderCards();
  atualizarKPI();
}

// Agrega dados conforme filtro
function aggregateData(){
  const filterType = $('viewFilter').value;
  const map = {};
  rmaData.forEach(d=>{
    const key = filterType==='FILIAL' ? (d.FILIAL?.trim().toUpperCase() || 'SEM FILIAL') : d.PRODUTO.trim().toUpperCase();
    if(!map[key]) map[key] = {CHAVE:key, TRINTA:0, SESSENTA:0, NOVENTA:0, VENCIDOS:0, PESO:0};
    const faixa = calculaVencimento(d.DATA);
    if(faixa==='TRINTA') map[key].TRINTA +=1;
    else if(faixa==='SESSENTA') map[key].SESSENTA +=1;
    else if(faixa==='NOVENTA') map[key].NOVENTA +=1;
    else if(faixa==='VENCIDOS') map[key].VENCIDOS +=1;
    map[key].PESO += parseFloat(d.PESO);
  });
  return Object.values(map);
}

// Plugin Chart.js para texto central
const centerText = {
  id:'centerText',
  beforeDraw(chart){
    const {ctx} = chart;
    const meta = chart.getDatasetMeta(0);
    if(!meta || !meta.data || !meta.data[0]) return;
    const centerX = meta.data[0].x;
    const centerY = meta.data[0].y;
    const total = chart.config.data.datasets[0].data.reduce((a,b)=>a+b,0);
    ctx.save();
    ctx.font='700 18px Inter, sans-serif';
    ctx.fillStyle='#e6eef6';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText(total, centerX, centerY);
    ctx.restore();
  }
};
Chart.register(centerText);

// Renderiza cards
function renderCards(){
  const grid = $('cardsGrid');
  grid.innerHTML='';
  const agg = aggregateData();
  agg.forEach(d=>{
    const card = document.createElement('div'); card.className='card';
    const title = document.createElement('h4'); title.textContent=d.CHAVE; card.appendChild(title);

    const delBtn = document.createElement('button'); delBtn.className='clear-btn'; delBtn.textContent='✕';
    delBtn.addEventListener('click',()=>{
      const filterType = $('viewFilter').value;
      if(filterType==='FILIAL'){
        rmaData = rmaData.filter(x=>x.FILIAL?.trim().toUpperCase()!==d.CHAVE);
      } else {
        rmaData = rmaData.filter(x=>x.PRODUTO.trim().toUpperCase()!==d.CHAVE);
      }
      saveData();
    });
    card.appendChild(delBtn);

    const canvas = document.createElement('canvas'); canvas.id='chart_'+d.CHAVE; canvas.style.maxWidth='220px'; card.appendChild(canvas);

    const metaDiv = document.createElement('div'); metaDiv.className='meta';
    metaDiv.innerHTML = `30d: ${d.TRINTA} | 60d: ${d.SESSENTA} | 90d: ${d.NOVENTA} | Vencidos: ${d.VENCIDOS} | Peso: ${d.PESO.toFixed(2)}kg`;
    card.appendChild(metaDiv);

    grid.appendChild(card);

    const color = corPorPeso(d.PESO);
    const chartData = [d.TRINTA + d.SESSENTA + d.NOVENTA, d.VENCIDOS];
    const colors = [color, '#ef4444'];

    if(charts[d.CHAVE]) charts[d.CHAVE].destroy();
    charts[d.CHAVE] = new Chart(canvas.getContext('2d'),{
      type:'doughnut',
      data:{labels:['Ativos','Vencidos'], datasets:[{data:chartData, backgroundColor:colors}]},
      options:{cutout:'68%', plugins:{legend:{display:false}, tooltip:{enabled:false}}},
      plugins:[centerText]
    });
  });
}

// Atualiza KPI geral
function atualizarKPI(){
  const agg = aggregateData();
  const totalRMA = agg.reduce((s,d)=>s+ d.TRINTA + d.SESSENTA + d.NOVENTA + d.VENCIDOS,0);
  const pesoTotal = agg.reduce((s,d)=>s+ d.PESO,0);
  const vencidos = agg.reduce((s,d)=>s+ d.VENCIDOS,0);
  $('totalRMA').textContent = totalRMA;
  $('pesoTotal').textContent = pesoTotal.toFixed(2)+' kg';
  $('totalVencidos').textContent = vencidos;
}

// Adicionar / Atualizar
$('btnAdd').addEventListener('click',()=>{
  const filial = $('inputFilial').value.trim();
  const produto = $('inputProduto').value.trim();
  const dataVenc = $('inputDate').value;
  const peso = parseFloat($('inputPeso').value);
  if(!filial || !produto || !dataVenc || isNaN(peso)) return alert('Preencha todos os campos');
  rmaData.push({FILIAL:filial, PRODUTO:produto, DATA:dataVenc, PESO:peso});
  saveData();
});

// Exportar JSON
$('btnExport').addEventListener('click',()=>{
  const blob = new Blob([JSON.stringify(rmaData,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='rmaData.json'; a.click();
  URL.revokeObjectURL(url);
});

// Importar JSON
$('importFile').addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = evt=>{
    try{
      const obj = JSON.parse(evt.target.result);
      if(Array.isArray(obj)){
        rmaData = obj;
        saveData();
      }
    }catch(err){ alert('Erro ao importar: '+err.message); }
  };
  r.readAsText(f);
});

// Troca de filtro
$('viewFilter').addEventListener('change',()=>{
  renderCards();
  atualizarKPI();
});

// Inicializa
renderCards();
atualizarKPI();
</script>
</body>
</html>

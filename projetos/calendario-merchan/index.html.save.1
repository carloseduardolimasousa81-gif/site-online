<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Calendário de Visitas</title>
<style>
body { font-family:sans-serif; margin:0; padding:20px; background:#fafafa;}
.header { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px; align-items:center;}
.grid { display:grid; grid-template-columns:repeat(7,1fr); gap:10px; margin-bottom:10px;}
input, select, button { padding:5px; }
.day { border:1px solid #ccc; padding:5px; cursor:pointer; background:#fff; min-height:80px; display:flex; flex-direction:column; justify-content:flex-start;}
.day.empty { background:transparent; border-color:transparent; cursor:default;}
.day img { max-width:80%; max-height:60px; object-fit:contain; margin-top:5px; align-self:center;}
#modal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center;}
.modal-content { background:#fff; padding:20px; width:300px;}
.modal-content select { width:100%; height:100px;}
.modal-content img { max-width:100%; margin-top:10px;}
.modal-content ul { padding-left:20px; margin:5px 0; font-size:12px;}
</style>
</head>
<body>

<div class="header">
<input type="text" id="nomeCalendario" placeholder="Nome do calendário">
<select id="mes"></select>
<input type="number" id="ano" min="2020" max="2100">
<button onclick="voltarHoje()">Hoje</button>
<button onclick="limparCalendario()" style="background:#d9534f; color:white; border:none; padding:5px 10px; cursor:pointer;">Limpar Calendário</button>
</div>

<div class="grid" id="diasSemana"></div>
<div class="grid" id="calendario"></div>

<div id="modal">
<div class="modal-content">
<h3 id="diaTitulo">Dia</h3>
<select id="selectLojas" multiple></select>
<input type="file" id="inputImagem">
<img id="preview" />
<button id="btnRemoverImagem" style="margin-top:10px; background:#d9534f; color:white; border:none; padding:5px 10px; cursor:pointer;">Remover imagem</button>
<div style="margin-top:10px;">
<button onclick="fecharModal()">Cancelar</button>
<button onclick="salvar()">Salvar</button>
</div>
</div>
</div>

<script>
const diasSemana=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
const nomesMeses=['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
const listaDeLojas=[ 
'AP02 - Jardim Oceânico','AP03 - Notre Dame','AP04 - Pau Ferro','AP05- Guinard','AP06 - Barra (Rio Design)',
'AP07 - Barra (Shell)','AP09 - Pedro Correa','AP10 - Ilha Guanabara','AP11 - Copacabana','AP14 - Geremário Dantas',
'AP15 - Tijuca','AP20 - PIRATININGA','AP21 - Abelardo Bueno','AP22 - Botafogo','AP25 - Ipanema','AP26 - Santa Rosa',
'AP28 - RECREIO AMERICAS','AP31 - CONDE DE BONFIM','AP32 - RECREIO GILKA','AP33- CATETE','AP36- COPACABANA II',
'AP37 - ITAIPU','AP43- ARARAS','AP48 - VALQUEIRE','AP50- ICARAÍ','AP51 - AEROTOWN','AP53- BARRA GOLF',
'AP55- ITAIPU II','AP 12 - TAQUARA','AP 08 - ANIL','AP 35 - NOVA IGUACU','AP 40 - BONSUCESSO','AP 18 - SHOP NOVA IGUACU',
'AP 34 - CACUIA','AP 27 - REALENGO','AP 30 - CAXIAS','AP 41 - BANGU','AP 39 - ESTACIO','AP 17 - DENDE',
'AP 24 - VILA ISABEL','AP 23 - MEIER','AP 13 - CAMPO GRANDE','AP 45 - SÃO JOÃO DE MERITI','AP 54 - CACHAMBI',
'AP 44 - CAMPO GRANDE II','AP16 - CHACHAMORRA','AP58 - VARGEM GRANDE','AP61 - PENDOTIBA','PÉS E PATAS SANTA CLARA','PÉS E PATAS COPACABANA',
'PÉS E PATAS BOTAFOGO','PÉS E PATAS GÁVEA','PÉS E PATAS GUANABARA','PÉS E PATAS PAULO GUSTAVO','PÉS E PATAS GAVIÃO PEIXOTO',
'PÉS E PATAS SANTA ROSA','PÉS E PATAS TIJUCA','PES E PATAS PIRATININGA','PES E PATAS ITAIPU','4 PATAS ITAIPU',
'PRA BICHO VISTA ALEGRE','PRA BICHO ILHA','PRA BICHO FLAMENGO','GALONI E NARDI','PET DO TOCO','AVIÁRIO DO PIAU','BICÃO RAÇÕES','MP ALMEIDA'
];

let ano=new Date().getFullYear();
let mes=new Date().getMonth();
let dias=[];
let diaSelecionado=null;
let imagemSelecionada='';

const elMes=document.getElementById('mes');
const elAno=document.getElementById('ano');
const elNome=document.getElementById('nomeCalendario');
const elSemana=document.getElementById('diasSemana');
const elCalendario=document.getElementById('calendario');
const elModal=document.getElementById('modal');
const elDiaTitulo=document.getElementById('diaTitulo');
const elSelectLojas=document.getElementById('selectLojas');
const elInputImagem=document.getElementById('inputImagem');
const elPreview=document.getElementById('preview');
const elBtnRemoverImagem=document.getElementById('btnRemoverImagem');

// IndexedDB
let db;
const DB_NAME='CalendarioVisitasDB';
const DB_VERSION=1;
const request=indexedDB.open(DB_NAME,DB_VERSION);
request.onupgradeneeded=e=>{db=e.target.result;if(!db.objectStoreNames.contains('imagens'))db.createObjectStore('imagens',{keyPath:'id'});};
request.onsuccess=e=>{db=e.target.result; renderizar();};
request.onerror=()=>alert('Erro ao abrir IndexedDB');

function salvarImagem(id,file){return new Promise((res,rej)=>{const tx=db.transaction('imagens','readwrite'); tx.objectStore('imagens').put({id,file}); tx.oncomplete=()=>res(); tx.onerror=()=>rej();});}
function obterImagem(id){return new Promise(res=>{const tx=db.transaction('imagens','readonly'); const req=tx.objectStore('imagens').get(id); req.onsuccess=()=>res(req.result?URL.createObjectURL(req.result.file):''); req.onerror=()=>res('');});}
function removerImagem(id){const tx=db.transaction('imagens','readwrite'); tx.objectStore('imagens').delete(id);}

// Header
diasSemana.forEach(d=>{const div=document.createElement('div');div.textContent=d;div.style.fontWeight='bold';div.style.padding='5px';elSemana.appendChild(div);});
nomesMeses.forEach((nome,idx)=>{const opt=document.createElement('option');opt.value=idx;opt.textContent=nome;elMes.appendChild(opt);});
elMes.value=mes;
elAno.value=ano;
elSelectLojas.innerHTML=listaDeLojas.map(l=>`<option value="${l}">${l}</option>`).join('');

// Upload
elInputImagem.addEventListener('change',e=>{const file=e.target.files[0];if(file){imagemSelecionada=file; elPreview.src=URL.createObjectURL(file);}});
elBtnRemoverImagem.addEventListener('click',()=>{imagemSelecionada=''; elInputImagem.value=''; elPreview.src='';});

// Gerar dias
function gerarDiasDoMes(ano,mes){
  const dias=[];
  const ultimoDia=new Date(ano,mes+1,0).getDate();
  for(let d=1;d<=ultimoDia;d++){
    dias.push({dia:d, info:[], imagem:''});
  }
  return dias;
}

// Renderizar calendário
async function renderizar(){
  dias=gerarDiasDoMes(ano,mes);
  const chave=`cal-${ano}-${mes}`;
  const salvo=JSON.parse(localStorage.getItem(chave));
  if(salvo)dias=dias.map(d=>{const e=salvo.find(s=>s.dia===d.dia); return e||d;});

  elCalendario.innerHTML='';
  const primeiroDia=new Date(ano,mes,1).getDay();
  let placeholders=primeiroDia; 
  for(let i=0;i<placeholders;i++){const ph=document.createElement('div');ph.className='day empty';elCalendario.appendChild(ph);}

  for(const d of dias){
    const div=document.createElement('div'); div.className='day'; div.innerHTML=`<strong>${d.dia}</strong>`;
    if(d.imagem){const url=await obterImagem(d.imagem); if(url) div.innerHTML+=`<br><img src="${url}" />`;}
    if(d.info.length) div.innerHTML+=`<ul>${d.info.map(l=>`<li>${l}</li>`).join('')}</ul>`;
    div.onclick=()=>abrirModal(d);
    elCalendario.appendChild(div);
  }
}

// Modal
function abrirModal(dia){
  diaSelecionado=dia;
  elDiaTitulo.textContent=`Dia ${dia.dia}`;
  if(dia.imagem instanceof File){elPreview.src=URL.createObjectURL(dia.imagem);} else elPreview.src='';
  Array.from(elSelectLojas.options).forEach(opt=>opt.selected=dia.info.includes(opt.value));
  elModal.style.display='flex';
}

async function salvar(){
  const selecionadas=Array.from(elSelectLojas.selectedOptions).map(o=>o.value).slice(0,4);
  diaSelecionado.info=selecionadas;
  if(imagemSelecionada instanceof File){
    const idImg=`img-${ano}-${mes}-${diaSelecionado.dia}`;
    await salvarImagem(idImg,imagemSelecionada);
    diaSelecionado.imagem=idImg;
  } else if(imagemSelecionada===''){
    if(diaSelecionado.imagem) removerImagem(diaSelecionado.imagem);
    diaSelecionado.imagem='';
  }
  const chave=`cal-${ano}-${mes}`;
  localStorage.setItem(chave,JSON.stringify(dias));
  elModal.style.display='none';
  renderizar();
}

function fecharModal(){elModal.style.display='none';}
function voltarHoje(){ano=new Date().getFullYear(); mes=new Date().getMonth(); elAno.value=ano; elMes.value=mes; renderizar();}
function limparCalendario(){dias.forEach(d=>{d.info=[]; if(d.imagem) removerImagem(d.imagem); d.imagem='';}); const chave=`cal-${ano}-${mes}`; localStorage.removeItem(chave); renderizar();}
elMes.addEventListener('change',()=>{mes=parseInt(elMes.value); renderizar();});
elAno.addEventListener('change',()=>{ano=parseInt(elAno.value); renderizar();});
elNome.addEventListener('input',()=>{localStorage.setItem('nomeCalendario',elNome.value);});
elNome.value=localStorage.getItem('nomeCalendario')||'';
renderizar();
</script>

<script src="storage.js"></script>
</body>
</html>


